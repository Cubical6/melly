# Melly Validation Requirements Specification

**Version**: 1.0.0
**Plugin**: `melly-validation`
**Location**: `/home/user/melly/validation/`
**Date**: 2025-11-15

---

## Overview

This document specifies the validation requirements for all Melly workflow components. All validation scripts are centralized in the `melly-validation` plugin for consistency and maintainability.

**Exit Code Convention**:
- `0` - Validation passed
- `1` - Non-blocking warning (user can continue)
- `2` - Blocking error (halt workflow)

---

## Table of Contents

1. [Validation Scripts Overview](#1-validation-scripts-overview)
2. [validate-init.py](#2-validate-initpy)
3. [validate-c1-systems.py](#3-validate-c1-systemspy)
4. [validate-c2-containers.py](#4-validate-c2-containerspy)
5. [validate-c3-components.py](#5-validate-c3-componentspy)
6. [validate-markdown.py](#6-validate-markdownpy)
7. [Supporting Scripts](#7-supporting-scripts)
8. [Validation Flow](#8-validation-flow)
9. [Error Scenarios](#9-error-scenarios)

---

## 1. Validation Scripts Overview

### Script Locations

All validation scripts are in: `validation/scripts/`

```
validation/
├── scripts/
│   ├── validate-init.py
│   ├── validate-c1-systems.py
│   ├── validate-c2-containers.py
│   ├── validate-c3-components.py
│   ├── validate-markdown.py
│   ├── create-folders.sh
│   └── check-timestamp.sh
└── templates/
    ├── init-template.json
    ├── c1-systems-template.json
    ├── c2-containers-template.json
    ├── c3-components-template.json
    ├── c1-markdown-template.md
    ├── c2-markdown-template.md
    └── c3-markdown-template.md
```

### When Scripts Are Called

```
/melly-init
  └─> validate-init.py

/melly-c1-systems
  ├─> check-timestamp.sh (if c1-systems.json exists)
  └─> validate-c1-systems.py

/melly-c2-containers
  ├─> check-timestamp.sh
  └─> validate-c2-containers.py

/melly-c3-components
  ├─> check-timestamp.sh
  └─> validate-c3-components.py

/melly-doc-c4model
  └─> validate-markdown.py (all generated files)
```

---

## 2. validate-init.py

### Purpose

Validates `init.json` generated by `/melly-init` command.

### Input
- **stdin**: JSON data from `init.json`
- **Expected location**: `knowledge-base/init.json`

### Validation Rules

#### 2.1 Schema Structure
- ✓ `version` matches semver pattern `^\d+\.\d+\.\d+$`
- ✓ `timestamp` is valid ISO 8601
- ✓ `metadata` object exists with required fields
- ✓ `repositories` array has at least 1 entry

#### 2.2 Repository Paths
- ✓ Each path is absolute (starts with `/` or drive letter)
- ✓ Each path exists on filesystem (**blocking if missing**)
- ✓ Each path is a directory (**blocking if file**)
- ✓ No duplicate paths (**blocking**)
- ✓ No duplicate names (**warning**)

#### 2.3 Package Manifests
- ✓ Each manifest has `type`, `path`, `data` fields
- ✓ Type is one of: `npm`, `composer`, `cargo`, `go-mod`, `pyproject`, etc.
- ✓ Path is relative (no leading `/`)
- ✓ Full path exists (**warning if missing**)
- ✓ Data is valid JSON object
- ✓ Manifest-specific validation (e.g., npm requires `name` field)

#### 2.4 Timestamps
- ✓ Timestamp not in future (**warning**)
- ✓ `timestamp` and `metadata.generated_at` within 1 hour (**warning**)

### Edge Cases

| Case | Action | Exit Code |
|------|--------|-----------|
| Empty repositories | Error: "No repositories found" | 2 |
| Path doesn't exist | Error: "Repository not found" | 2 |
| Invalid JSON | Error: "Invalid JSON" | 2 |
| Missing version | Error: "Missing field: version" | 2 |
| No manifests | Warning: "No package manifests" | 1 |
| Unknown manifest type | Warning: "Unknown type: X" | 1 |

### Error Message Format

```
[VALIDATE-INIT] ERROR: {error message}
  Location: {field path}
  Expected: {expected value}
  Actual: {actual value}

[VALIDATE-INIT] WARNING: {warning message}
  Recommendation: {suggested fix}
```

---

## 3. validate-c1-systems.py

### Purpose

Validates `c1-systems.json` generated by `/melly-c1-systems` command.

### Dependencies
- Requires `init.json` to exist
- Validates parent timestamp reference

### Validation Rules

#### 3.1 Parent Reference
- ✓ `init.json` exists (**blocking if missing**)
- ✓ `parent.timestamp` matches `init.json` timestamp (**blocking if mismatch**)
- ✓ This file's timestamp > parent timestamp (**blocking if older**)

#### 3.2 Systems
- ✓ Each system has unique `id` (**blocking if duplicate**)
- ✓ ID matches pattern `^[a-z0-9-]+$`
- ✓ Type is one of: `internal`, `external`, `web-application`, `api-service`, etc.
- ✓ Repositories reference valid names from `init.json` (**warning if not found**)

#### 3.3 Observations
See **[observations-relations-schema.md](./observations-relations-schema.md)** for complete specification.

- ✓ Each has unique `id` within system scope
- ✓ Category from enum: `architectural`, `technical`, `security`, etc.
- ✓ Severity is `info`, `warning`, or `critical`
- ✓ Description minimum 10 characters

#### 3.4 Relations (Graph Validity)
See **[observations-relations-schema.md](./observations-relations-schema.md)** for complete specification.

- ✓ Each has unique `id` within system scope
- ✓ Source and target reference valid system IDs (**warning if not found**)
- ✓ No self-references (**warning**)
- ✓ Type from enum: `uses`, `provides`, `depends_on`, etc.
- ✓ No dangling references
- ✓ Circular dependencies detected (**warning only**)

### Edge Cases

| Case | Action | Exit Code |
|------|--------|-----------|
| init.json missing | Error: "Parent not found" | 2 |
| Timestamp mismatch | Error: "Parent timestamp mismatch" | 2 |
| Duplicate system ID | Error: "Duplicate id: X" | 2 |
| Timestamp older than parent | Error: "Must be newer" | 2 |
| Unknown repository | Warning: "Repo not found: X" | 1 |
| Circular dependency | Warning: "Circular: A→B→A" | 1 |

---

## 4. validate-c2-containers.py

### Purpose

Validates `c2-containers.json` generated by `/melly-c2-containers` command.

### Dependencies
- Requires `init.json` and `c1-systems.json`

### Validation Rules

#### 4.1 Parent Reference
- ✓ `c1-systems.json` exists (**blocking**)
- ✓ Parent timestamp matches (**blocking**)
- ✓ Timestamp ordering: init < c1 < c2 (**blocking**)

#### 4.2 Containers
- ✓ Unique `id` per container (**blocking**)
- ✓ `system_id` references valid system from c1-systems.json (**blocking**)
- ✓ Type from enum: `web_application`, `database`, `api`, etc.

#### 4.3 Technology Stack
- ✓ `primary_language` non-empty
- ✓ `framework` non-empty (or "none")
- ✓ `runtime` non-empty
- ✓ Consistency check (e.g., React with Node.js) (**warning if mismatch**)

#### 4.4 Deployment
- ✓ `environment` from enum: `browser`, `server`, `cloud`, etc.
- ✓ `containerized` is boolean
- ✓ Platform consistent with containerized flag (**warning**)

#### 4.5 Observations & Relations
- Same rules as c1-systems.py
- Relations must reference valid container IDs

### Edge Cases

| Case | Action | Exit Code |
|------|--------|-----------|
| Invalid system_id | Error: "System not found: X" | 2 |
| Empty containers | Error: "No containers" | 2 |
| Tech stack mismatch | Warning: "Inconsistent: X" | 1 |
| System has no containers | Warning: "System X empty" | 1 |

---

## 5. validate-c3-components.py

### Purpose

Validates `c3-components.json` generated by `/melly-c3-components` command.

### Dependencies
- Requires `init.json`, `c1-systems.json`, `c2-containers.json`

### Validation Rules

#### 5.1 Parent Reference
- ✓ `c2-containers.json` exists (**blocking**)
- ✓ Timestamp ordering: init < c1 < c2 < c3 (**blocking**)

#### 5.2 Components
- ✓ Unique `id` per component (**blocking**)
- ✓ `container_id` references valid container (**blocking**)
- ✓ Type from enum: `controller`, `service`, `repository`, etc.
- ✓ `responsibility` non-empty

#### 5.3 Code Structure
- ✓ `language` consistent with container technology
- ✓ `path` is relative (no leading `/`)
- ✓ `files` array present (**warning if empty**)

#### 5.4 Component Hierarchy
- ✓ Every component belongs to exactly one container
- ✓ Components don't span containers (**warning**)

#### 5.5 Relations (Coupling Analysis)
- ✓ Source/target reference valid component IDs
- ✓ Type from enum: `depends_on`, `calls`, `imports`, `uses`, etc.
- ✓ Coupling is `tight`, `loose`, or `none`
- ✓ High tight coupling detected (**warning - code smell**)
- ✓ Circular dependencies (**warning**)

### Edge Cases

| Case | Action | Exit Code |
|------|--------|-----------|
| Invalid container_id | Error: "Container not found" | 2 |
| Empty components | Error: "No components" | 2 |
| Empty files array | Warning: "No files: X" | 1 |
| Tight coupling | Warning: "High coupling: A→B" | 1 |
| Language mismatch | Warning: "Language mismatch" | 1 |

---

## 6. validate-markdown.py

### Purpose

Validates markdown documentation generated by `/melly-doc-c4model` command.

### Input
- **Arguments**: File path(s) to validate
- **Locations**: `knowledge-base/systems/*/c1/*.md`, `c2/*.md`, `c3/*.md`

### Validation Rules

#### 6.1 Frontmatter (YAML)
- ✓ Starts with `---` and ends with `---`
- ✓ Valid YAML syntax (**blocking**)
- ✓ Required fields: `id`, `name`, `level`, `type`, `timestamp`
- ✓ `level` is `c1`, `c2`, or `c3` (**blocking**)
- ✓ `type` matches level (system/container/component) (**blocking**)
- ✓ `parent` required for c2/c3 (**warning if missing**)

#### 6.2 Heading Hierarchy
- ✓ Exactly one H1 at top (**blocking**)
- ✓ H1 follows pattern: `# {name} (C1|C2|C3 - ...)` (**warning**)
- ✓ H2 sections valid: `Overview`, `Observations`, `Relations`, etc.
- ✓ No orphan headings (**warning**)

#### 6.3 Required Sections
- ✓ `## Overview` exists (**blocking**)
- ✓ `## Observations` exists (**warning**)
- ✓ `## Relations` exists (**warning**)

#### 6.4 Level-Specific Sections
- C2: `## Technology Stack` (**warning if missing**)
- C3: `## Code Structure` (**warning if missing**)

#### 6.5 Content Quality
- ✓ No placeholder text ("TODO", "TBD") (**warning**)
- ✓ Descriptions not empty (**warning**)
- ✓ Code blocks have language (**warning**)
- ✓ Internal links valid (**warning if broken**)

### Edge Cases

| Case | Action | Exit Code |
|------|--------|-----------|
| Invalid YAML | Error: "Invalid YAML" | 2 |
| Missing required field | Error: "Missing: X" | 2 |
| No H1 | Error: "Missing H1" | 2 |
| No Overview | Error: "Missing Overview" | 2 |
| Broken link | Warning: "Broken link: X" | 1 |
| Placeholder text | Warning: "Found TODO" | 1 |

---

## 7. Supporting Scripts

### 7.1 create-folders.sh

#### Purpose
Creates directory structure for a C4 system.

#### Usage
```bash
create-folders.sh <system-name> [base-path]
```

#### Creates
```
knowledge-base/systems/{system-name}/
├── c1/
├── c2/
├── c3/
├── c4/
└── README.md
```

#### Validation
- ✓ System name argument provided (**exit 1**)
- ✓ Name matches pattern `^[a-z0-9-]+$` (**exit 1**)
- ✓ Base path exists and writable (**exit 1**)
- ✓ System folder doesn't exist (**warning, skip creation**)

#### Exit Codes
- `0` - Success
- `1` - Error (invalid input or filesystem error)

### 7.2 check-timestamp.sh

#### Purpose
Compares timestamps between parent and child JSON files.

#### Usage
```bash
check-timestamp.sh <parent-file> <child-file>
```

#### Validation
- ✓ Both files exist (**exit 2**)
- ✓ Both are valid JSON (**exit 2**)
- ✓ Both have `timestamp` field (**exit 2**)
- ✓ Timestamps valid ISO 8601 (**exit 2**)
- ✓ Child > parent (**exit 1 if not**)

#### Exit Codes
- `0` - Valid order (child > parent)
- `1` - Invalid order (child ≤ parent)
- `2` - Error (file not found, invalid JSON)

#### Output Format
```
[CHECK-TIMESTAMP] ✓ Valid order
  Parent: 2025-11-15T10:00:00Z
  Child:  2025-11-15T11:30:00Z
  Difference: 1.5 hours
```

---

## 8. Validation Flow

### 8.1 Workflow Integration

```mermaid
graph TD
    A[/melly-init] --> B[validate-init.py]
    B -->|exit 0| C[Commit]
    B -->|exit 2| D[Halt]

    E[/melly-c1-systems] --> F[check-timestamp.sh]
    F --> G[validate-c1-systems.py]
    G -->|exit 0| H[create-folders.sh]
    H --> I[Commit]
    G -->|exit 2| D

    J[/melly-c2-containers] --> K[check-timestamp.sh]
    K --> L[validate-c2-containers.py]
    L -->|exit 0| M[Commit]
    L -->|exit 2| D
```

### 8.2 Exit Code Decision Tree

```
Validation Execution
    │
    ├─> Exit 0 (SUCCESS)
    │   ├─> Log success
    │   ├─> Continue workflow
    │   └─> Commit changes
    │
    ├─> Exit 1 (WARNING)
    │   ├─> Log warnings
    │   ├─> Ask user: "Continue? [y/n]"
    │   ├─> If yes: continue
    │   └─> If no: halt
    │
    └─> Exit 2 (BLOCKING ERROR)
        ├─> Log errors
        ├─> Show fix recommendations
        ├─> Halt workflow
        └─> Do NOT commit
```

### 8.3 Configuration Options

```json
{
  "validation": {
    "strict_mode": false,
    "prompt_on_warning": true
  }
}
```

- `strict_mode`: Treat warnings as errors (exit 1 → exit 2)
- `prompt_on_warning`: Ask user before continuing on warnings

---

## 9. Error Scenarios

### Scenario 1: Missing Parent File

**Command**: `/melly-c1-systems`

**Error**:
```
[VALIDATE-C1] ERROR: Parent file not found
  Expected: knowledge-base/init.json
  Actual: File does not exist

RECOMMENDATION: Run /melly-init first
```

**Exit Code**: 2 (blocking)

### Scenario 2: Timestamp Out of Order

**Command**: `/melly-c2-containers`

**Error**:
```
[CHECK-TIMESTAMP] ✗ Invalid order
  Parent: 2025-11-15T14:00:00Z
  Child:  2025-11-15T10:00:00Z
  ERROR: Child is 4 hours older than parent

RECOMMENDATION: Delete c2-containers.json and re-run
```

**Exit Code**: 2 (blocking)

### Scenario 3: Invalid System Reference

**Command**: `/melly-c2-containers`

**Error**:
```
[VALIDATE-C2] ERROR: System not found
  Container: frontend-spa
  Field: system_id
  Expected: Valid system ID from c1-systems.json
  Actual: "web-app-system" (not found)

Available systems: payment-system, auth-system, api-gateway

RECOMMENDATION: Fix system_id or add system to c1-systems.json
```

**Exit Code**: 2 (blocking)

### Scenario 4: Warnings with Continue

**Command**: `/melly-c1-systems`

**Warnings**:
```
[VALIDATE-C1] WARNING: No observations
  System: auth-system
  Recommendation: Add observations

[VALIDATE-C1] WARNING: Circular dependency
  Path: auth-system → api-gateway → auth-system
  Recommendation: Review architecture

[VALIDATE-C1] PASSED with 2 warning(s)

Continue? [y/n]:
```

**Exit Code**: 1 (warning)

---

## Implementation Checklist

- [ ] Implement `validate-init.py`
- [ ] Implement `validate-c1-systems.py`
- [ ] Implement `validate-c2-containers.py`
- [ ] Implement `validate-c3-components.py`
- [ ] Implement `validate-markdown.py`
- [ ] Implement `create-folders.sh`
- [ ] Implement `check-timestamp.sh`
- [ ] Create unit tests for each validator
- [ ] Test with valid input (should pass)
- [ ] Test with invalid input (should fail)
- [ ] Test edge cases
- [ ] Integration tests with workflow

---

**Document Version**: 1.0.0
**Date**: 2025-11-15
**Status**: Specification Complete - Ready for Implementation
