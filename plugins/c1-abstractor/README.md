# c1-abstractor

> C4 Model Level 1 (System Context) analyzer agent for the Melly workflow

## Overview

The **c1-abstractor** is a specialized Claude Code agent that analyzes code repositories and identifies systems at the C4 Model Level 1 (System Context) abstraction level.

**What it does:**
- Identifies software systems from repositories
- Detects actors (users and external systems)
- Defines system boundaries (scope, deployment, network)
- Maps relationships between systems
- Documents architectural observations with evidence
- Generates structured `c1-systems.json` output

**What makes it unique:**
- Follows Claude Code best practices (simple 4-step workflow, <150 lines)
- Leverages c4model-c1 skill for comprehensive C1 methodology
- Validation-driven with melly-validation integration
- Incremental processing support for large codebases

---

## Installation

### Prerequisites

1. **Required plugins:**
   - `c4model-c1` (v2.0.0+) - C1 methodology skill
   - `melly-validation` (v1.0.0+) - Validation scripts

2. **Input file:**
   - `init.json` - Generated by `/melly-init` command

### Install Plugin

```bash
# From Melly marketplace
/plugin add c1-abstractor

# Or manually
cp -r plugins/c1-abstractor ~/.claude/plugins/
```

---

## Usage

### Quick Start

```
> Use the c1-abstractor agent to analyze my repositories
```

Claude will automatically:
1. Load `init.json`
2. Apply C4 Level 1 methodology
3. Generate `c1-systems.json`
4. Validate output
5. Report results

### Via Slash Command (Recommended)

```
> /melly-c1-systems
```

This command orchestrates the c1-abstractor agent with proper error handling and validation.

### Manual Invocation

```
> Launch the c1-abstractor agent with init.json
```

---

## Workflow

The agent follows a **simple 4-step workflow**:

### Step 1: Validate and Load
- Checks `init.json` exists
- Parses repository metadata
- Verifies structure

### Step 2: Analyze Repositories
- Loads c4model-c1 skill for methodology
- Identifies systems using C4 rules
- Detects actors and boundaries
- Maps relationships
- Documents observations with evidence

### Step 3: Generate c1-systems.json
- Creates structured output following schema
- Includes metadata, systems, actors, summary
- Timestamps for incremental updates

### Step 4: Validate and Report
- Runs validation script
- Reports errors or success
- Suggests next steps

---

## Output Structure

**File:** `c1-systems.json`

```json
{
  "metadata": {
    "schema_version": "1.0.0",
    "timestamp": "2025-11-17T10:00:00.000Z",
    "parent": {
      "file": "init.json",
      "timestamp": "2025-11-17T09:00:00.000Z"
    }
  },
  "systems": [
    {
      "id": "web-frontend",
      "name": "Web Frontend",
      "type": "web-application",
      "description": "Customer-facing e-commerce web application",
      "repositories": ["/repos/frontend-spa"],
      "boundaries": {
        "scope": "internal",
        "deployment": "cloud",
        "network": "public"
      },
      "responsibilities": ["Display product catalog", "..."],
      "observations": [
        {
          "id": "obs-arch-spa-react",
          "category": "architecture",
          "severity": "info",
          "description": "SPA using React framework",
          "evidence": [...]
        }
      ],
      "relations": [
        {
          "target": "api-backend",
          "type": "http-rest",
          "direction": "outbound",
          "description": "Fetches data via REST API"
        }
      ]
    }
  ],
  "actors": [...],
  "summary": {
    "total_systems": 4,
    "total_actors": 3
  }
}
```

---

## Configuration

### Agent Settings

The agent is configured in `agents/c1-abstractor.md`:

- **Model:** `sonnet` (Claude 3.5 Sonnet)
- **Tools:** Read, Grep, Write, Bash, Skill
- **Dependencies:** c4model-c1 skill, melly-validation

### Customization

To customize behavior, edit the agent file:

```bash
nano plugins/c1-abstractor/agents/c1-abstractor.md
```

---

## Examples

### Example 1: Simple Web Application

**Input:** Single repository with React frontend

**Output:**
```
✅ C1 Systems Analysis Complete

Systems Identified: 1
- web-application: 1

Actors Identified: 2
- user: 1
- external-service: 1

Output: c1-systems.json
Status: ✅ Validated
```

### Example 2: Microservices Architecture

**Input:** Multiple repositories (API gateway, user service, payment service)

**Output:**
```
✅ C1 Systems Analysis Complete

Systems Identified: 5
- api-service: 3
- message-broker: 1
- database: 1

Actors Identified: 4
- user: 1
- external-service: 3

Output: c1-systems.json
Status: ✅ Validated
```

---

## Validation

The agent automatically validates output using:

```bash
python plugins/melly-validation/scripts/validate-c1-systems.py c1-systems.json
```

**Validation checks:**
- ✅ Schema structure correct
- ✅ Timestamp ordering (child > parent)
- ✅ Unique system IDs
- ✅ Valid relationship targets
- ✅ Required fields present
- ✅ Kebab-case ID format

**Exit codes:**
- `0` - Validation passed
- `1` - Warning (non-blocking)
- `2` - Error (blocking)

---

## Troubleshooting

### Issue: "init.json not found"

**Solution:** Run `/melly-init` first to generate `init.json`

### Issue: "Validation failed - timestamp ordering"

**Cause:** `c1-systems.json` timestamp is older than `init.json`

**Solution:** Re-run the agent to regenerate with correct timestamp

### Issue: "No systems identified"

**Possible causes:**
- Empty repositories in `init.json`
- Repositories lack package manifests
- Technology not recognized

**Solution:** Check `init.json` content, ensure repositories have package.json or similar

### Issue: "Relation target not found"

**Cause:** Relationship references non-existent system ID

**Solution:** Check system IDs in relations array, ensure all targets exist

---

## Best Practices

### ✅ DO:

1. **Run `/melly-init` first** - Ensure `init.json` exists
2. **Review output** - Check `c1-systems.json` for accuracy
3. **Provide feedback** - Correct system names/types if needed
4. **Use descriptive names** - "Customer Web Portal" not "Frontend"
5. **Define boundaries clearly** - Specify scope, deployment, network

### ❌ DON'T:

1. **Don't skip validation** - Always verify output
2. **Don't use technology names** - ❌ "React App" → ✅ "Web Application"
3. **Don't over-granularize** - Combine related functionality into one system
4. **Don't forget evidence** - Every observation needs supporting evidence
5. **Don't use vague relationships** - Specify direction and type clearly

---

## Integration

### Workflow Position

```
/melly-init
    ↓ (generates init.json)
/melly-c1-systems  ← THIS AGENT
    ↓ (generates c1-systems.json)
/melly-c2-containers
    ↓
/melly-c3-components
    ↓
/melly-doc-c4model
```

### Dependencies

**Required:**
- c4model-c1 skill - Provides C1 methodology
- melly-validation - Validation scripts and templates

**Input:**
- `init.json` - Repository metadata from /melly-init

**Output:**
- `c1-systems.json` - Used by /melly-c2-containers

---

## Technical Details

### Agent Architecture

**Design Philosophy:**
- Simple 4-step workflow (not 9-step as originally planned)
- Skill-driven methodology (c4model-c1 provides rules)
- Validation-first approach
- Built-in tools only (no external script dependencies in core workflow)

**Size:** 151 lines (within 150-line best practice limit)

**Complexity:** Low - Linear workflow, clear responsibilities

### Performance

**Typical execution time:**
- Small project (1-3 repos): 30-60 seconds
- Medium project (5-10 repos): 1-2 minutes
- Large project (20+ repos): 3-5 minutes

**Optimization:**
- Incremental processing support (timestamp-based)
- Parallel repository analysis (future enhancement)

---

## Contributing

### Reporting Issues

Found a bug or have a suggestion?

1. Check existing issues in repository
2. Create new issue with:
   - Description of problem
   - Steps to reproduce
   - Expected vs actual behavior
   - `init.json` sample (if relevant)

### Development

To extend or modify:

1. Fork the repository
2. Edit `agents/c1-abstractor.md`
3. Follow best practices (Section 0 in TASKS.md)
4. Test with sample repositories
5. Submit pull request

---

## License

MIT License - See repository LICENSE file

---

## References

- **C4 Model Methodology:** [docs/c4model-methodology.md](../../docs/c4model-methodology.md)
- **c4model-c1 Skill:** [plugins/c4model-c1/](../c4model-c1/)
- **Validation Scripts:** [plugins/melly-validation/](../melly-validation/)
- **Workflow Guide:** [docs/workflow-guide.md](../../docs/workflow-guide.md)
- **TASKS.md Section 6.2:** [TASKS.md](../../TASKS.md#62-sub-agent-c1-abstractor)

---

**Plugin Version:** 1.0.0
**Last Updated:** 2025-11-17
**Compatibility:** Melly 1.0.0+, Claude Code 1.0.0+
